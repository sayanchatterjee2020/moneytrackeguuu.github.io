<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="img/budget.png">
  <title>Money Tracker</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body>
  <!-- Navbar ======================================================== -->
  <nav class="navbar py-3">
    <div class="container">
      <a class="navbar-brand"><img src="img/budget.png" alt="Logo" class="img-fluid"></a>
      <h5 class="text-center">Money<br />Tracker</h5>
      <form class="d-flex" role="search">
        <!-- <button id="reset-btn" class="reset-btn rounded-4 shadow-lg"></button> -->
        <button type="button" class="profile-btn rounded-4 shadow-lg" data-bs-toggle="modal"
          data-bs-target="#exampleModal">
          <i class="fa-regular fa-user"></i>
        </button>
      </form>
    </div>
  </nav>

  <!-- Body ========================================================== -->
  <section id="main" class="my-3">
    <div class="container">
      <div class="row">
        <!-- Balance Display ========================================= -->
        <div class="col-md-4 col-10 display_balance mb-3 rounded-4 shadow-lg ">
          <h5 class="text-center my-2">Your total Balance is</h5>
          <h1 class="text-center">â‚¹<span id="total-balance">0.00</span></h1>
          <div class="row ballance-row bg-light rounded-4 shadow-lg py-3 my-2">
            <div class="col-6 d-flex align-items-center justify-content-center">
              <p class="income text-success text-center">Income:<br> â‚¹<span id="total-income">0.00</span></p>
            </div>
            <div class="col-6 d-flex align-items-center justify-content-center">
              <p class="expense text-danger text-center">Expense:<br> â‚¹<span id="total-expense">0.00</span></p>
            </div>
          </div>
        </div>



        <!-- Transaction Form ======================================== -->
        <div class="col-md-6 col-10 add_balance rounded-4 shadow-lg">
          <div class="p-4 ">
            <h5 class="text-center fw-bold mb-3">Add Your New Transaction</h5>

            <form id="transactionForm">
              <div class="row">
                <div class="col-6">
                  <!-- Type -->
                  <div class="mb-3">
                    <select class="form-select" id="type" required>
                      <option value="income">Income</option>
                      <option value="expense">Expense</option>
                    </select>
                  </div>
                </div>
                <div class="col-6">
                  <!-- Amount -->
                  <div class="mb-3">
                    <div class="input-group">
                      <span class="input-group-text">â‚¹</span>
                      <input type="number" class="form-control" id="amount" placeholder="0" required>
                      <span class="input-group-text">.00</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-6">
                  <!-- Description -->
                  <div class="mb-3">
                    <input type="text" class="form-control" id="description" placeholder="Enter description" required>
                  </div>
                </div>
                <div class="col-6">
                  <!-- Date -->
                  <div class="mb-3">
                    <input type="date" class="form-control" id="date" required>
                  </div>
                </div>
              </div>
              <!-- Submit -->
              <div class="text-center">
                <button type="submit" class="add-btn rounded-4 shadow-lg px-4"><i class="fa-solid fa-plus"></i> Add
                  Transaction</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>


  <!-- Chart ========================================================= -->
  <section id="chart" class="my-5">

    <div class="container">
      <table class="table table-dark table-striped rounded-4" id="transactionsTable">
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Action</th>
        </tr>
        <tbody id="transactionsBody"></tbody>
      </table>
    </div>
  </section>


  <!-- Modal ========================================================= -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Profile</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- Modal body =================================================== -->
        <div class="modal-body text-center">
          <div class="row">
            <div class="col-4">
              <img id="user-pic" src="" alt="User" class="rounded-circle mb-2 d-block mx-auto"
                style="width:80px; height:80px; object-fit:cover;">
            </div>
            <div class="col-8">
              <h4 id="user-name" class="fw-bold d-block mb-3">Sayan Chatterjee</h4>

              <button id="logout-btn" class="log-out rounded-4">
                <i class="fa-solid fa-right-from-bracket"></i> Sign Out
              </button>
            </div>
          </div>
        </div>
        <!-- Modal footer ================================================== -->

        <div class="modal-footer d-flex flex-column align-items-start w-100">
          <button id="download-pdf" class="download-btn text-start" style="width: 100%;">
            <span class="fw-bold">Download Transaction</span><br>
            Download last 30 days transaction details.
          </button>

          <button id="reset-btn" class="reset-btn text-start" style="width: 100%;">
            <span class="fw-bold">Factory Data Reset</span><br>
            Erase all data from server.
          </button>

          <button class="about-btn text-start" style="width: 100%;">
            <span class="fw-bold">About Us</span><br>
            Know about us.
          </button>
        </div>


      </div>
    </div>
  </div>






  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
  <!-- Firebase SDK + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    // ==================== FIREBASE IMPORTS ====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    // ==================== FIREBASE CONFIG ====================
    const firebaseConfig = {
      apiKey: "AIzaSyC-kYbgEvN4Gq5-Vk6TppWWMV0Du9yMCSE",
      authDomain: "moneytracker-7fd26.firebaseapp.com",
      projectId: "moneytracker-7fd26",
      storageBucket: "moneytracker-7fd26.firebasestorage.app",
      messagingSenderId: "608935835423",
      appId: "1:608935835423:web:0d6b70634767349166222a",
      measurementId: "G-H37FNNWG9J"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ==================== AUTH CHECK ====================
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        document.getElementById("user-name").textContent = user.displayName;
        document.getElementById("user-pic").src = user.photoURL;
        document.getElementById("user-pic").style.display = "block";
      }
    });

    // ðŸšª Log out
    document.getElementById("logout-btn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // ==================== TRACKER LOGIC ====================
    const form = document.getElementById("transactionForm");
    const tbody = document.getElementById("transactionsBody");
    const totalBalanceEl = document.getElementById("total-balance");
    const totalIncomeEl = document.getElementById("total-income");
    const totalExpenseEl = document.getElementById("total-expense");
    const downloadBtn = document.getElementById("download-pdf");
    const resetBtn = document.getElementById("reset-btn");

    // âž• Add transaction
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const type = document.getElementById("type").value;
      const description = document.getElementById("description").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const date = document.getElementById("date").value;

      if (!type || !description || !amount || !date) {
        alert("Please fill all fields");
        return;
      }

      await addDoc(collection(db, "transactions"), {
        type,
        description,
        amount,
        date,
        createdAt: serverTimestamp()
      });

      form.reset();
      loadTransactions();
    });

    // ðŸ“¥ Load transactions (last 7 days)
    async function loadTransactions() {
      tbody.innerHTML = "";
      let totalIncome = 0;
      let totalExpense = 0;

      const snapshot = await getDocs(collection(db, "transactions"));
      const transactions = [];

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const id = docSnap.id;
        transactions.push({ id, ...data });
      });

      // Sort transactions by date (newest first)
      transactions.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        if (dateA.getTime() !== dateB.getTime()) return dateB - dateA;
        if (a.createdAt && b.createdAt) return b.createdAt.seconds - a.createdAt.seconds;
        return 0;
      });

      // Take only the last 10 transactions
      const latestTransactions = transactions.slice(0, 10);

      latestTransactions.forEach(data => {
        if (data.type === "income") totalIncome += data.amount;
        else totalExpense += data.amount;

        const tr = document.createElement("tr");
        tr.className = data.type;
        tr.innerHTML = `
      <td>${data.date}</td>
      <td>${data.type.toUpperCase()}</td>
      <td>${data.description}</td>
      <td>${data.amount.toFixed(2)}</td>
      <td><button class="delete-btn" data-id="${data.id}"><i class="fa-solid fa-trash"></i></button></td>
    `;
        tbody.appendChild(tr);
      });

      totalIncomeEl.textContent = totalIncome.toFixed(2);
      totalExpenseEl.textContent = totalExpense.toFixed(2);
      totalBalanceEl.textContent = (totalIncome - totalExpense).toFixed(2);

      attachDelete();
    }

    function attachDelete() {
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (confirm("Delete this transaction?")) {
            await deleteDoc(doc(db, "transactions", id));
            loadTransactions();
          }
        });
      });
    }


// ðŸ“„ Download PDF for last 30 days =========================================================
downloadBtn.addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  // ðŸ“ Heading
  pdf.setFontSize(14);
  pdf.text("Last 30 Days Transaction Record", 14, 15);

  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);

  const transactions = [];
  const snapshot = await getDocs(collection(db, "transactions"));
  snapshot.forEach((docSnap) => {
    const data = docSnap.data();
    const txDate = new Date(data.date);
    if (txDate >= thirtyDaysAgo) {
      transactions.push(data);
    }
  });

  // Sort transactions (newest first)
  transactions.sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    if (dateA.getTime() !== dateB.getTime()) return dateB - dateA;
    if (a.createdAt && b.createdAt) return b.createdAt.seconds - a.createdAt.seconds;
    return 0;
  });

  if (transactions.length === 0) {
    alert("No transactions in last 30 days.");
    return;
  }

  // âœ… Calculate total balance
  let totalIncome = 0;
  let totalExpense = 0;
  transactions.forEach(tx => {
    if (tx.type.toLowerCase() === "income") {
      totalIncome += tx.amount;
    } else if (tx.type.toLowerCase() === "expense") {
      totalExpense += tx.amount;
    }
  });
  const totalBalance = totalIncome - totalExpense;

  // ðŸ“ Show total balance below heading
  pdf.setFontSize(12);
  pdf.text(`Your Current Balance: ${totalBalance.toFixed(2)}`, 14, 23);

  // ðŸŸ© Prepare table rows with + / - amounts
  const rows = transactions.map(tx => {
    const sign = tx.type.toLowerCase() === "income" ? "+" : "-";
    return [
      tx.date,
      tx.type.toUpperCase(),
      tx.description,
      `${sign}${tx.amount.toFixed(2)}`
    ];
  });

  // ðŸ“Š Generate table with color styling
  pdf.autoTable({
    head: [['Date', 'Type', 'Description', 'Amount']],
    body: rows,
    startY: 30,
    didParseCell: (data) => {
      // Type column coloring
      if (data.section === 'body' && data.column.index === 1) {
        const type = data.cell.text[0];
        if (type === 'INCOME') {
          data.cell.styles.textColor = [0, 128, 0]; // green
          data.cell.styles.fontStyle = 'bold';
        } else if (type === 'EXPENSE') {
          data.cell.styles.textColor = [255, 0, 0]; // red
          data.cell.styles.fontStyle = 'bold';
        }
      }
      // Amount column coloring (+ / -)
      if (data.section === 'body' && data.column.index === 3) {
        const text = data.cell.text[0];
        if (text.startsWith("+")) {
          data.cell.styles.textColor = [0, 128, 0]; // green
          data.cell.styles.fontStyle = 'bold';
        } else if (text.startsWith("-")) {
          data.cell.styles.textColor = [255, 0, 0]; // red
          data.cell.styles.fontStyle = 'bold';
        }
      }
    }
  });

  // ðŸ’¾ Save PDF
  pdf.save("MoneyTracker_Last30Days.pdf");
});







    // ðŸ§¹ Factory Reset
    resetBtn.addEventListener("click", async () => {
      if (!confirm("âš ï¸ This will permanently delete ALL data. Continue?")) return;
      const snapshot = await getDocs(collection(db, "transactions"));
      const deletions = [];
      snapshot.forEach(docSnap => {
        deletions.push(deleteDoc(doc(db, "transactions", docSnap.id)));
      });
      await Promise.all(deletions);
      alert("All transactions deleted âœ…");
      loadTransactions();
    });

    // ðŸš€ Initial Load
    loadTransactions();
  </script>




</body>

</html>